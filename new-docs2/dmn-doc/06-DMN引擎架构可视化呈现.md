# DMN 决策引擎架构可视化呈现

## 1. 整体架构图

### 1.1 系统架构全景图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              DMN 决策引擎系统架构                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    应用层                                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │
│  │   业务应用 A     │  │   业务应用 B     │  │   业务应用 C     │  │   管理控制台     │     │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘     │
└───────────│─────────────────────│─────────────────────│─────────────────────│─────────────┘
            │                     │                     │                     │
            ▼                     ▼                     ▼                     ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    API 层                                                │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              DmnEngine                                              │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐  │  │
│  │  │DmnDecisionService│  │DmnRepositoryService│  │DmnHistoryService│  │DmnMgmtService │  │  │
│  │  │   决策执行服务    │  │   仓库管理服务    │  │   历史服务      │  │   管理服务    │  │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └───────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    核心层                                                │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                         DmnEngineConfiguration                                      │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        CommandExecutor                                        │  │  │
│  │  │  ┌───────────────────────────────────────────────────────────────────────┐  │  │  │
│  │  │  │                     Command Interceptor Chain                           │  │  │  │
│  │  │  │  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌───────────────────────┐   │  │  │  │
│  │  │  │  │  Log    │──▶│   Tx    │──▶│ Schema  │──▶│   DmnCommandInvoker   │   │  │  │  │
│  │  │  │  └─────────┘   └─────────┘   └─────────┘   └───────────────────────┘   │  │  │  │
│  │  │  └───────────────────────────────────────────────────────────────────────┘  │  │  │
│  │  └─────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                    │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                          DmnEngineAgenda                                     │  │  │
│  │  │  ┌────────────────────────────┐  ┌────────────────────────────────────────┐ │  │  │
│  │  │  │  ExecuteDecisionOperation  │  │  ExecuteDecisionServiceOperation       │ │  │  │
│  │  │  └──────────────┬─────────────┘  └────────────────────────────────────────┘ │  │  │
│  │  └─────────────────│───────────────────────────────────────────────────────────┘  │  │
│  │                    │                                                               │  │
│  │                    ▼                                                               │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                       RuleEngineExecutor                                     │  │  │
│  │  │  ┌────────────────────────────────────────────────────────────────────────┐ │  │  │
│  │  │  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐  │ │  │  │
│  │  │  │  │ ExpressionManager│  │ HitPolicyBehaviors│  │   AuditContainer    │  │ │  │  │
│  │  │  │  │    表达式管理     │  │    命中策略       │  │     审计追踪         │  │ │  │  │
│  │  │  │  └──────────────────┘  └──────────────────┘  └──────────────────────┘  │ │  │  │
│  │  │  └────────────────────────────────────────────────────────────────────────┘ │  │  │
│  │  └────────────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    持久层                                                │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           DeploymentManager                                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        DefinitionCache                                         │  │  │
│  │  │  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────────┐    │  │  │
│  │  │  │ Decision Cache    │  │ DRD Cache         │  │  Resource Cache       │    │  │  │
│  │  │  └───────────────────┘  └───────────────────┘  └───────────────────────┘    │  │  │
│  │  └─────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        Entity Managers                                        │  │  │
│  │  │  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────────┐    │  │  │
│  │  │  │DecisionEntityMgr  │  │DeploymentEntityMgr│  │HistoricDecisionExecMgr│    │  │  │
│  │  │  └───────────────────┘  └───────────────────┘  └───────────────────────┘    │  │  │
│  │  └─────────────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                              │
│                                          ▼                                              │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           DbSqlSession / MyBatis                                    │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    数据层                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │                              数据库 (MySQL/PostgreSQL/Oracle)                        ││
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────┐ ││
│  │  │ ACT_DMN_DEPLOYMENT  │  │   ACT_DMN_DECISION  │  │ACT_DMN_HI_DECISION_EXECUTION│ ││
│  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────────────┘ ││
│  │  ┌─────────────────────────────┐                                                   ││
│  │  │ACT_DMN_DEPLOYMENT_RESOURCE  │                                                   ││
│  │  └─────────────────────────────┘                                                   ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 模块依赖图

### 2.1 模块关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              模块依赖关系图                                              │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────────────┐
                              │   flowable-dmn-api   │
                              │   (接口定义层)        │
                              └──────────┬───────────┘
                                         │
                                         │ 依赖
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              flowable-dmn-engine                                         │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              内部模块依赖                                           │  │
│  │                                                                                    │  │
│  │    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │  │
│  │    │   engine    │────▶│    impl     │────▶│ persistence │────▶│     db      │   │  │
│  │    │  (核心接口)  │     │  (实现层)   │     │ (持久化层)  │     │  (数据库)   │   │  │
│  │    └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘   │  │
│  │         │                    │                    │                               │  │
│  │         │                    │                    │                               │  │
│  │         ▼                    ▼                    ▼                               │  │
│  │    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                        │  │
│  │    │  hitpolicy  │     │     el      │     │   deployer  │                        │  │
│  │    │ (命中策略)  │     │ (表达式)    │     │  (部署器)   │                        │  │
│  │    └─────────────┘     └─────────────┘     └─────────────┘                        │  │
│  │         │                    │                                                   │  │
│  │         │                    │                                                   │  │
│  │         ▼                    ▼                                                   │  │
│  │    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │  │
│  │    │    cmd      │     │   parser    │     │   agenda    │     │ interceptor │   │  │
│  │    │  (命令)     │     │  (解析器)   │     │  (议程)     │     │  (拦截器)   │   │  │
│  │    └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘   │  │
│  │                                                                                    │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                         │
                                         │ 依赖
                                         ▼
                              ┌──────────────────────┐
                              │ flowable-common-engine│
                              │   (公共引擎组件)       │
                              └──────────────────────┘
```

### 2.2 类依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              核心类依赖关系                                               │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                            ┌────────────────────────┐
                            │      DmnEngine         │
                            │  ┌──────────────────┐  │
                            │  │ - configuration  │  │
                            │  │ - services       │  │
                            │  └──────────────────┘  │
                            └───────────┬────────────┘
                                        │
            ┌───────────────────────────┼───────────────────────────┐
            │                           │                           │
            ▼                           ▼                           ▼
┌───────────────────────┐  ┌───────────────────────┐  ┌───────────────────────┐
│ DmnDecisionService    │  │ DmnRepositoryService  │  │ DmnHistoryService     │
│  ┌─────────────────┐  │  │  ┌─────────────────┐  │  │  ┌─────────────────┐  │
│  │ - ruleExecutor  │  │  │  │ - deploymentMgr │  │  │  │ - historicMgr   │  │
│  │ - cmdExecutor   │  │  │  │ - definitionCache│ │  │  │ - cmdExecutor   │  │
│  └─────────────────┘  │  │  └─────────────────┘  │  │  └─────────────────┘  │
└───────────┬───────────┘  └───────────┬───────────┘  └───────────────────────┘
            │                          │
            ▼                          ▼
┌───────────────────────┐  ┌───────────────────────┐
│ RuleEngineExecutor    │  │ DeploymentManager     │
│  ┌─────────────────┐  │  │  ┌─────────────────┐  │
│  │ - hitPolicies   │  │  │  │ - definitionCache│ │
│  │ - exprManager   │  │  │  │ - deployers      │  │
│  │ - objectMapper  │  │  │  └─────────────────┘  │
│  └─────────────────┘  │  └───────────────────────┘
└───────────┬───────────┘
            │
            ▼
┌───────────────────────────────────────────────────────────────────────┐
│                         HitPolicy Behaviors                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │   UNIQUE    │  │    FIRST    │  │    ANY      │  │   COLLECT   │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │
│  │  PRIORITY   │  │ RULE_ORDER  │  │OUTPUT_ORDER │                   │
│  └─────────────┘  └─────────────┘  └─────────────┘                   │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心业务流程图

### 3.1 决策执行时序图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              决策执行时序图                                               │
└─────────────────────────────────────────────────────────────────────────────────────────┘

  Client          DmnDecisionService    CommandExecutor    DmnCommandInvoker    RuleEngineExecutor
    │                    │                    │                    │                    │
    │  executeDecision() │                    │                    │                    │
    ├───────────────────▶│                    │                    │                    │
    │                    │                    │                    │                    │
    │                    │  execute(Cmd)      │                    │                    │
    │                    ├───────────────────▶│                    │                    │
    │                    │                    │                    │                    │
    │                    │                    │  invoke(Cmd)       │                    │
    │                    │                    ├───────────────────▶│                    │
    │                    │                    │                    │                    │
    │                    │                    │                    │  execute(Decision) │
    │                    │                    │                    ├───────────────────▶│
    │                    │                    │                    │                    │
    │                    │                    │                    │                    │
    │                    │                    │                    │     ┌──────────────┤
    │                    │                    │                    │     │ 1. 创建上下文 │
    │                    │                    │                    │     │ 2. 健全性检查 │
    │                    │                    │                    │     │ 3. 评估规则   │
    │                    │                    │                    │     │ 4. 组合结果   │
    │                    │                    │                    │     └──────────────┤
    │                    │                    │                    │                    │
    │                    │                    │                    │  AuditContainer    │
    │                    │                    │                    │◀───────────────────┤
    │                    │                    │                    │                    │
    │                    │                    │  AuditContainer    │                    │
    │                    │                    │◀───────────────────┤                    │
    │                    │                    │                    │                    │
    │                    │  List<Map>         │                    │                    │
    │                    │◀───────────────────┤                    │                    │
    │                    │                    │                    │                    │
    │  List<Map>         │                    │                    │                    │
    │◀───────────────────┤                    │                    │                    │
    │                    │                    │                    │                    │
```

### 3.2 规则评估流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              规则评估流程图                                               │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │   开始评估      │
                              └────────┬────────┘
                                       │
                                       ▼
                        ┌──────────────────────────────┐
                        │  获取决策表 DecisionTable     │
                        └──────────────┬───────────────┘
                                       │
                                       ▼
                        ┌──────────────────────────────┐
                        │  创建执行上下文               │
                        │  ELExecutionContext          │
                        └──────────────┬───────────────┘
                                       │
                                       ▼
                        ┌──────────────────────────────┐
                        │  健全性检查                   │
                        │  sanityCheck()               │
                        └──────────────┬───────────────┘
                                       │
                                       ▼
                        ┌──────────────────────────────┐
                        │  遍历规则列表                 │◀─────────────────────────────┐
                        │  for (rule in rules)         │                              │
                        └──────────────┬───────────────┘                              │
                                       │                                              │
                                       ▼                                              │
                        ┌──────────────────────────────┐                              │
                        │  评估规则条件                 │                              │
                        │  executeRule()               │                              │
                        └──────────────┬───────────────┘                              │
                                       │                                              │
                         ┌─────────────┴─────────────┐                                │
                         │                           │                                │
                         ▼                           ▼                                │
                ┌────────────────┐          ┌────────────────┐                        │
                │   规则匹配      │          │   规则不匹配    │                        │
                │  ruleResult    │          │  !ruleResult   │                        │
                │    = true      │          │    = false     │                        │
                └───────┬────────┘          └───────┬────────┘                        │
                        │                           │                                │
                        ▼                           │                                │
                ┌────────────────┐                  │                                │
                │  检查 HitPolicy │                  │                                │
                │  有效性验证     │                  │                                │
                └───────┬────────┘                  │                                │
                        │                           │                                │
                        ▼                           │                                │
                ┌────────────────┐                  │                                │
                │  收集规则输出   │                  │                                │
                │  validRules    │                  │                                │
                └───────┬────────┘                  │                                │
                        │                           │                                │
                        └─────────────┬─────────────┘                                │
                                      │                                              │
                                      ▼                                              │
                        ┌──────────────────────────────┐                              │
                        │  是否继续评估？               │                              │
                        │  shouldContinueEvaluating()  │                              │
                        └──────────────┬───────────────┘                              │
                                       │                                              │
                         ┌─────────────┴─────────────┐                                │
                         │                           │                                │
                         ▼                           ▼                                │
                ┌────────────────┐          ┌────────────────┐                        │
                │   继续评估      │          │   停止评估      │                        │
                │   continue     │──────────│   break        │                        │
                └────────────────┘          └───────┬────────┘                        │
                         │                          │                                 │
                         │                          │                                 │
                         └──────────────────────────┼─────────────────────────────────┘
                                                    │
                                                    ▼
                                     ┌──────────────────────────────┐
                                     │  组合规则结论                 │
                                     │  composeOutputEntryResult()  │
                                     └──────────────┬───────────────┘
                                                    │
                                                    ▼
                                     ┌──────────────────────────────┐
                                     │  组合决策结果                 │
                                     │  composeDecisionResults()    │
                                     └──────────────┬───────────────┘
                                                    │
                                                    ▼
                                     ┌──────────────────────────────┐
                                     │  结束审计追踪                 │
                                     │  stopAudit()                 │
                                     └──────────────┬───────────────┘
                                                    │
                                                    ▼
                                              ┌───────────┐
                                              │   返回     │
                                              │  结果      │
                                              └───────────┘
```

---

## 4. 状态管理图

### 4.1 决策执行状态图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              决策执行状态图                                               │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │     CREATED     │
                              │   (已创建)      │
                              └────────┬────────┘
                                       │
                                       │ startAudit()
                                       ▼
                              ┌─────────────────┐
                              │   EVALUATING    │
                              │   (评估中)      │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
                    ▼                  ▼                  ▼
           ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
           │ RULE_MATCHED  │  │ RULE_SKIPPED  │  │  RULE_ERROR   │
           │ (规则匹配)    │  │ (规则跳过)    │  │  (规则错误)   │
           └───────┬───────┘  └───────────────┘  └───────┬───────┘
                   │                                      │
                   │ composeResult()                      │ recordError()
                   ▼                                      ▼
           ┌───────────────┐                      ┌───────────────┐
           │   COMPLETED   │                      │    FAILED     │
           │   (完成)      │                      │   (失败)      │
           └───────┬───────┘                      └───────┬───────┘
                   │                                      │
                   │ stopAudit()                          │ stopAudit()
                   ▼                                      ▼
           ┌─────────────────────────────────────────────────────┐
           │                    TERMINATED                        │
           │                    (终止)                            │
           └─────────────────────────────────────────────────────┘
```

### 4.2 部署生命周期状态图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              部署生命周期状态图                                           │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │    CREATED      │
                              │   (已创建)      │
                              └────────┬────────┘
                                       │
                                       │ deploy()
                                       ▼
                              ┌─────────────────┐
                              │    DEPLOYING    │
                              │   (部署中)      │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
                    ▼                  ▼                  ▼
           ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
           │   PARSING     │  │   CACHING     │  │   PERSISTING  │
           │  (解析中)     │  │  (缓存中)     │  │  (持久化中)   │
           └───────┬───────┘  └───────┬───────┘  └───────┬───────┘
                   │                  │                  │
                   └──────────────────┼──────────────────┘
                                      │
                                      ▼
                              ┌─────────────────┐
                              │    DEPLOYED     │
                              │   (已部署)      │
                              └────────┬────────┘
                                       │
                                       │ deleteDeployment()
                                       ▼
                              ┌─────────────────┐
                              │    DELETED      │
                              │   (已删除)      │
                              └─────────────────┘
```

---

## 5. 组件交互图

### 5.1 服务层交互图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              服务层组件交互图                                             │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                     DmnEngine                                            │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           DmnEngineConfiguration                                    │  │
│  │                                                                                    │  │
│  │   ┌──────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                        CommandExecutor                                     │   │  │
│  │   │                                                                            │   │  │
│  │   │   ┌──────────────────────────────────────────────────────────────────┐   │   │  │
│  │   │   │                    Interceptor Chain                               │   │   │  │
│  │   │   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────────┐   │   │   │  │
│  │   │   │  │  Log    │─▶│   Tx    │─▶│ Schema  │─▶│ DmnCommandInvoker   │   │   │   │  │
│  │   │   │  └─────────┘  └─────────┘  └─────────┘  └──────────┬──────────┘   │   │   │  │
│  │   │   │                                                     │              │   │   │  │
│  │   │   └─────────────────────────────────────────────────────│──────────────┘   │   │  │
│  │   │                                                          │                  │   │  │
│  │   └──────────────────────────────────────────────────────────│──────────────────┘   │  │
│  │                                                              │                      │  │
│  │   ┌──────────────────────────────────────────────────────────│──────────────────┐   │  │
│  │   │                     Services                               │                  │   │  │
│  │   │                                                           ▼                  │   │  │
│  │   │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │   │  │
│  │   │  │DmnDecisionService│  │DmnRepositoryService│  │    DmnHistoryService     │  │   │  │
│  │   │  │                 │  │                 │  │                           │  │   │  │
│  │   │  │ createBuilder() │  │ createDeployment│  │ createHistoricQuery()     │  │   │  │
│  │   │  │ executeDecision │  │ createQuery()   │  │ deleteHistoricExecutions  │  │   │  │
│  │   │  └────────┬────────┘  └────────┬────────┘  └───────────────────────────┘  │   │  │
│  │   │           │                    │                                            │   │  │
│  │   │           │    ┌───────────────┘                                            │   │  │
│  │   │           │    │                                                            │   │  │
│  │   │           ▼    ▼                                                            │   │  │
│  │   │  ┌─────────────────────────────────────────────────────────────────────┐  │   │  │
│  │   │  │                     DeploymentManager                                │  │   │  │
│  │   │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │  │   │  │
│  │   │  │  │ DefinitionCache │  │    Deployers    │  │  EntityManagers     │  │  │   │  │
│  │   │  │  └─────────────────┘  └─────────────────┘  └─────────────────────┘  │  │   │  │
│  │   │  └─────────────────────────────────────────────────────────────────────┘  │   │  │
│  │   │                                                                           │   │  │
│  │   └───────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                    │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 数据访问层交互图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              数据访问层交互图                                             │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                     Entity Managers                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────┐│  │
│  │  │ DecisionEntityManager│  │DeploymentEntityMgr  │  │HistoricDecisionExecEntityMgr││  │
│  │  │                     │  │                     │  │                             ││  │
│  │  │ findById()          │  │ findById()          │  │ findById()                  ││  │
│  │  │ findByKey()         │  │ insert()            │  │ insert()                    ││  │
│  │  │ findByDeploymentId()│  │ delete()            │  │ findByQuery()               ││  │
│  │  └──────────┬──────────┘  └──────────┬──────────┘  └──────────────┬──────────────┘│  │
│  │             │                        │                            │               │  │
│  └─────────────│────────────────────────│────────────────────────────│───────────────┘  │
│                │                        │                            │                   │
│                ▼                        ▼                            ▼                   │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              Data Managers                                         │  │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────┐│  │
│  │  │ DecisionDataManager │  │DeploymentDataManager│  │HistoricDecisionExecDataMgr  ││  │
│  │  │                     │  │                     │  │                             ││  │
│  │  │ selectById()        │  │ selectById()        │  │ selectById()                ││  │
│  │  │ selectByKey()       │  │ insert()            │  │ insert()                    ││  │
│  │  │ selectByQuery()     │  │ delete()            │  │ selectByQuery()             ││  │
│  │  └──────────┬──────────┘  └──────────┬──────────┘  └──────────────┬──────────────┘│  │
│  │             │                        │                            │               │  │
│  └─────────────│────────────────────────│────────────────────────────│───────────────┘  │
│                │                        │                            │                   │
│                ▼                        ▼                            ▼                   │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              DbSqlSession                                          │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                           MyBatis Session                                     │  │  │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │  │  │
│  │  │  │ Decision.xml    │  │ DmnDeployment.xml│  │HistoricDecisionExecution.xml│  │  │  │
│  │  │  │ (SQL 映射)      │  │ (SQL 映射)       │  │ (SQL 映射)                  │  │  │  │
│  │  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │  │  │
│  │  └─────────────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
│                │                        │                            │                   │
│                ▼                        ▼                            ▼                   │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              Database                                              │  │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────────────┐│  │
│  │  │ ACT_DMN_DECISION    │  │ACT_DMN_DEPLOYMENT   │  │ACT_DMN_HI_DECISION_EXECUTION││  │
│  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────────────┘│  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. HitPolicy 策略模式图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              HitPolicy 策略模式架构                                       │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────────────────┐
                              │     HitPolicyBehavior       │
                              │        (接口)               │
                              ├─────────────────────────────┤
                              │ + getHitPolicyName()        │
                              │ + shouldContinueEvaluating()│
                              │ + evaluateRuleValidity()    │
                              │ + composeOutput()           │
                              └──────────────┬──────────────┘
                                             │
                                             │ implements
                                             │
                              ┌──────────────┴──────────────┐
                              │                             │
                              ▼                             ▼
              ┌───────────────────────────────┐  ┌───────────────────────────┐
              │    AbstractHitPolicy          │  │   行为标记接口             │
              │         (抽象基类)            │  ├───────────────────────────┤
              ├───────────────────────────────┤  │ ContinueEvaluatingBehavior│
              │ # multipleResults: boolean    │  │ EvaluateRuleValidityBehavior│
              │                               │  │ ComposeRuleResultBehavior  │
              │ + shouldContinueEvaluating()  │  │ ComposeDecisionResultBehavior│
              │ + composeRuleResult()         │  └───────────────────────────┘
              │ + composeDecisionResults()    │
              └──────────────┬────────────────┘
                             │
         ┌───────────────────┼───────────────────┬───────────────────┬─────────────────┐
         │                   │                   │                   │                 │
         ▼                   ▼                   ▼                   ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ HitPolicyUnique │ │ HitPolicyFirst  │ │ HitPolicyAny    │ │ HitPolicyCollect│ │ HitPolicyPriority│
│                 │ │                 │ │                 │ │                 │ │                 │
│ - 只允许一条规则│ │ - 返回第一条匹配│ │ - 允许多条匹配  │ │ - 收集所有结果  │ │ - 按优先级返回  │
│ - 违反则抛异常  │ │ - 找到后停止    │ │ - 输出必须相同  │ │ - 支持聚合      │ │ - 最高优先级优先│
└─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘
         │                   │                   │                   │
         │                   │                   │                   │
         ▼                   ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              策略选择器                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │  Map<String, AbstractHitPolicy> hitPolicyBehaviors                                 │  │
│  │                                                                                    │  │
│  │  "UNIQUE"      -> HitPolicyUnique                                                 │  │
│  │  "FIRST"       -> HitPolicyFirst                                                  │  │
│  │  "ANY"         -> HitPolicyAny                                                    │  │
│  │  "COLLECT"     -> HitPolicyCollect                                                │  │
│  │  "PRIORITY"    -> HitPolicyPriority                                               │  │
│  │  "RULE ORDER"  -> HitPolicyRuleOrder                                              │  │
│  │  "OUTPUT ORDER"-> HitPolicyOutputOrder                                            │  │
│  └───────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 数据库 ER 图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              DMN 数据库 ER 图                                            │
└─────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────┐           ┌─────────────────────────────────────┐
│     ACT_DMN_DEPLOYMENT      │           │  ACT_DMN_DEPLOYMENT_RESOURCE        │
├─────────────────────────────┤           ├─────────────────────────────────────┤
│ PK  ID_                     │◀────────┐ │ PK  ID_                             │
│     NAME_                   │         │ │ FK  DEPLOYMENT_ID_  ────────────────┤
│     CATEGORY_               │         │ │     NAME_                           │
│     TENANT_ID_              │         │ │     RESOURCE_BYTES_ (LONGBLOB)      │
│     DEPLOY_TIME_            │         │ └─────────────────────────────────────┘
│ FK  PARENT_DEPLOYMENT_ID_   │         │
└──────────────┬──────────────┘         │
               │                        │
               │ 1:N                    │
               │                        │
               ▼                        │
┌─────────────────────────────┐         │
│     ACT_DMN_DECISION        │         │
├─────────────────────────────┤         │
│ PK  ID_                     │         │
│     KEY_                    │         │
│     NAME_                   │         │
│     VERSION_                │         │
│     CATEGORY_               │         │
│     DECISION_TYPE_          │         │
│ FK  DEPLOYMENT_ID_ ─────────┼─────────┘
│     TENANT_ID_              │
│     RESOURCE_NAME_          │
│     DESCRIPTION_            │
└──────────────┬──────────────┘
               │
               │ 1:N
               │
               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                        ACT_DMN_HI_DECISION_EXECUTION                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│ PK  ID_                                                                                 │
│ FK  DECISION_DEFINITION_ID_  ───────────────────────────────────────────────────────────┤
│ FK  DEPLOYMENT_ID_                                                                      │
│     START_TIME_                                                                         │
│     END_TIME_                                                                           │
│     INSTANCE_ID_                                                                        │
│     EXECUTION_ID_                                                                       │
│     ACTIVITY_ID_                                                                        │
│     SCOPE_TYPE_                                                                         │
│     FAILED_ (TINYINT)                                                                   │
│     TENANT_ID_                                                                          │
│     EXECUTION_JSON_ (LONGTEXT)                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 总结

本文档提供了 DMN 决策引擎的完整可视化架构呈现，包括：

1. **整体架构图**：展示系统各层组件及其关系
2. **模块依赖图**：展示模块间和类间的依赖关系
3. **核心业务流程图**：展示决策执行和规则评估的完整流程
4. **状态管理图**：展示决策执行和部署的状态变化
5. **组件交互图**：展示服务层和数据访问层的组件交互
6. **HitPolicy 策略模式图**：展示命中策略的设计架构
7. **数据库 ER 图**：展示数据库表结构关系

这些可视化图表帮助开发者快速理解 DMN 引擎的整体架构和核心设计。
