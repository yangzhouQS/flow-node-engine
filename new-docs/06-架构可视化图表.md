# Flowable Engine 架构可视化图表

## 1. 整体架构图

### 1.1 系统层次架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              应用层 (Application Layer)                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │   REST API       │  │   Spring Boot    │  │   OSGi Bundle    │              │
│  │                  │  │                  │  │                  │              │
│  │  - flowable-rest │  │  - flowable-sb   │  │  - flowable-osgi  │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              服务层 (Service Layer)                        │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │  ProcessEngine   │  │   AppEngine      │  │   DmnEngine      │              │
│  │                  │  │                  │  │                  │              │
│  │  - Repository   │  │  - AppRepo       │  │  - DmnRepo        │              │
│  │  - Runtime       │  │  - AppMgmt       │  │  - DmnRule        │              │
│  │  - Task          │  │                  │  │  - DmnHistory      │              │
│  │  - History       │  │                  │  │                  │              │
│  │  - Identity      │  │                  │  │                  │              │
│  │  - Management    │  │                  │  │                  │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                             引擎层 (Engine Layer)                          │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │  BPMN Engine    │  │   CMMN Engine    │  │   Idm Engine      │              │
│  │                  │  │                  │  │                  │              │
│  │  - Process Def  │  │  - Case Def       │  │  - User           │              │
│  │  - Process Inst  │  │  - Case Inst      │  │  - Group          │              │
│  │  - Execution     │  │  - Milestone      │  │  - Privilege      │              │
│  │  - Task          │  │  - Task           │  │                  │              │
│  │  - Gateway       │  │  - Event          │  │                  │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            数据层 (Data Layer)                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │    MyBatis       │  │   DataSource      │  │     Cache         │              │
│  │                  │  │                  │  │                  │              │
│  │  - Mapper XML    │  │  - Connection     │  │  - Process Def   │              │
│  │  - Entity        │  │  - Transaction    │  │  - Deployment     │              │
│  │  - SQL           │  │  - Pool           │  │  - Process Inst   │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 模块依赖架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          公共API层 (Common API)                            │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │flowable-engine-  │  │flowable-app-     │  │flowable-dmn-      │              │
│  │common-api        │  │engine-api         │  │api                │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          模型层 (Model Layer)                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │flowable-bpmn-    │  │flowable-dmn-     │  │flowable-cmmn-     │              │
│  │model             │  │model             │  │model             │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          引擎层 (Engine Layer)                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │flowable-engine    │  │flowable-app-      │  │flowable-dmn-      │              │
│  │                  │  │engine             │  │engine             │              │
│  │flowable-cmmn-    │  │                  │  │                  │              │
│  │engine            │  │                  │  │                  │              │
│  │flowable-idm-     │  │                  │  │                  │              │
│  │engine            │  │                  │  │                  │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          服务层 (Service Layer)                            │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │flowable-task-     │  │flowable-variable- │  │flowable-job-      │              │
│  │service           │  │service           │  │service           │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          集成层 (Integration Layer)                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │flowable-spring    │  │flowable-spring-  │  │flowable-camel     │              │
│  │                  │  │boot              │  │                  │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          REST层 (REST Layer)                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │flowable-rest      │  │flowable-app-      │  │flowable-dmn-      │              │
│  │                  │  │rest              │  │rest              │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 模块依赖关系图

### 2.1 核心模块依赖图

```
flowable-engine-common-api
    │
    ├── flowable-engine-common
    │       │
    │       ├── flowable-engine
    │       │       │
    │       │       ├── flowable-task-service
    │       │       │       │
    │       │       │       └── flowable-task-service-api
    │       │       │
    │       │       ├── flowable-variable-service
    │       │       │       │
    │       │       │       └── flowable-variable-service-api
    │       │       │
    │       │       ├── flowable-job-service
    │       │       │       │
    │       │       │       └── flowable-job-service-api
    │       │       │
    │       │       ├── flowable-eventsubscription-service
    │       │       │       │
    │       │       │       └── flowable-eventsubscription-service-api
    │       │       │
    │       │       └── flowable-identitylink-service
    │       │               │
    │       │               └── flowable-identitylink-service-api
    │       │
    │       ├── flowable-app-engine
    │       │       │
    │       │       ├── flowable-task-service
    │       │       └── flowable-variable-service
    │       │
    │       ├── flowable-dmn-engine
    │       │       │
    │       │       ├── flowable-dmn-model
    │       │       ├── flowable-dmn-xml-converter
    │       │       └── flowable-variable-service
    │       │
    │       ├── flowable-cmmn-engine
    │       │       │
    │       │       ├── flowable-cmmn-model
    │       │       ├── flowable-cmmn-converter
    │       │       └── flowable-variable-service
    │       │
    │       └── flowable-idm-engine
    │               │
    │               └── flowable-idm-api
    │
    ├── flowable-bpmn-model
    │       │
    │       ├── flowable-engine
    │       └── flowable-bpmn-converter
    │
    ├── flowable-dmn-model
    │       │
    │       ├── flowable-dmn-engine
    │       └── flowable-dmn-xml-converter
    │
    └── flowable-cmmn-model
            │
            ├── flowable-cmmn-engine
            └── flowable-cmmn-converter
```

### 2.2 集成模块依赖图

```
flowable-engine
    │
    ├── flowable-spring
    │       │
    │       └── flowable-spring-boot
    │
    ├── flowable-camel
    │
    └── flowable-cxf

flowable-app-engine
    │
    ├── flowable-spring
    │       │
    │       └── flowable-spring-boot
    │
    └── flowable-app-rest

flowable-dmn-engine
    │
    ├── flowable-spring
    │       │
    │       └── flowable-spring-boot
    │
    └── flowable-dmn-rest

flowable-cmmn-engine
    │
    ├── flowable-spring
    │       │
    │       └── flowable-spring-boot
    │
    └── flowable-cmmn-rest

flowable-idm-engine
    │
    ├── flowable-spring
    │       │
    │       └── flowable-spring-boot
    │
    └── flowable-idm-rest
```

## 3. 核心业务流程时序图

### 3.1 流程部署时序图

```
用户              RepositoryService      DeploymentBuilder      Database
  │                      │                       │                   │
  │ createDeployment()    │                       │                   │
  ├─────────────────────>│                       │                   │
  │                      │                       │                   │
  │                      │ addResource()         │                   │
  │                      ├──────────────────────>│                   │
  │                      │                       │                   │
  │                      │ deploy()              │                   │
  │                      ├──────────────────────>│                   │
  │                      │                       │                   │
  │                      │                       │ INSERT deployment  │
  │                      │                       ├──────────────────>│
  │                      │                       │                   │
  │                      │                       │ INSERT resource    │
  │                      │                       ├──────────────────>│
  │                      │                       │                   │
  │                      │                       │ INSERT process_def │
  │                      │                       ├──────────────────>│
  │                      │                       │                   │
  │                      │ return Deployment      │                   │
  │                      │<──────────────────────┤                   │
  │                      │                       │                   │
  │ return Deployment      │                       │                   │
  │<─────────────────────┤                       │                   │
```

### 3.2 流程启动时序图

```
用户              RuntimeService       ProcessDefinitionCache      ExecutionManager      Database
  │                      │                       │                       │                   │
  │ startProcessInstance() │                       │                       │
  ├─────────────────────>│                       │                       │
  │                      │                       │                   │
  │                      │ getProcessDefinition() │                       │
  │                      ├──────────────────────>│                       │
  │                      │                       │                   │
  │                      │                       │ check cache            │
  │                      │                       │                   │
  │                      │                       │ not found              │
  │                      │                       ├──────────────────────>│
  │                      │                       │                   │
  │                      │                       │ SELECT process_def    │
  │                      │                       │                   ├──────────────────>│
  │                      │                       │                   │
  │                      │                       │ return process_def    │
  │                      │                       │<──────────────────────┤
  │                      │                       │                   │
  │                      │ return process_def    │                       │
  │                      │<──────────────────────┤                       │
  │                      │                       │                   │
  │                      │ createExecution()      │                       │
  │                      ├──────────────────────>│                       │
  │                      │                       │                   │
  │                      │                       │ INSERT process_inst   │
  │                      │                       │                   ├──────────────────>│
  │                      │                       │                   │
  │                      │                       │ INSERT execution      │
  │                      │                       │                   ├──────────────────>│
  │                      │                       │                   │
  │                      │ return ProcessInstance │                       │
  │                      │<──────────────────────┤                       │
  │                      │                       │                   │
  │ return ProcessInstance │                       │                   │
  │<─────────────────────┤                       │                   │
```

### 3.3 任务完成时序图

```
用户              TaskService          TaskEntity         TaskListener         Database
  │                      │                   │                   │                   │
  │ complete(taskId)      │                   │                   │
  ├─────────────────────>│                   │                   │
  │                      │                   │                   │
  │                      │ getTask(taskId)    │                   │
  │                      ├──────────────────>│                   │
  │                      │                   │                   │
  │                      │ return Task        │                   │
  │                      │<──────────────────┤                   │
  │                      │                   │                   │
  │                      │ fireCompleteEvent()│                   │
  │                      ├──────────────────>│                   │
  │                      │                   │                   │
  │                      │                   │ notify()          │
  │                      │                   ├──────────────────>│
  │                      │                   │                   │
  │                      │                   │                   │
  │                      │                   │ update task        │
  │                      │                   ├──────────────────>│
  │                      │                   │                   │
  │                      │                   │ UPDATE task SET     │
  │                      │                   │                   ├──────────────────>│
  │                      │                   │                   │
  │                      │                   │                   │
  │                      │                   │ signal execution    │
  │                      │                   ├──────────────────>│
  │                      │                   │                   │
  │                      │                   │ UPDATE execution     │
  │                      │                   │                   ├──────────────────>│
  │                      │                   │                   │
  │                      │                   │                   │
  │                      │                   │                   │
  │                      │ return             │                   │
  │                      │<──────────────────┤                   │
  │                      │                   │                   │
  │ return                │                   │                   │
  │<─────────────────────┤                   │                   │
```

## 4. 核心状态管理机制

### 4.1 流程实例状态图

```
        ┌─────────────┐
        │   CREATED   │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │   RUNNING   │◄─────────────────────────────┐
        └──────┬──────┘                              │
               │                                     │
               │ 暂停                               │
               ▼                                     │
        ┌─────────────┐                              │
        │  SUSPENDED  │                              │
        └──────┬──────┘                              │
               │                                     │
               │ 恢复                               │
               │                                     │
               └─────────────────────────────────────┘
               │
               │ 完成/取消
               ▼
        ┌─────────────┐
        │ COMPLETED   │
        └─────────────┘
               │
               ▼
        ┌─────────────┐
        │ CANCELLED   │
        └─────────────┘
```

### 4.2 任务状态图

```
        ┌─────────────┐
        │   CREATED   │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │  ASSIGNED   │◄─────────────────────────────┐
        └──────┬──────┘                              │
               │                                     │
               │ 认领                                 │
               ▼                                     │
        ┌─────────────┐                              │
        │   CLAIMED   │                              │
        └──────┬──────┘                              │
               │                                     │
               │ 完成                                 │
               ▼                                     │
        ┌─────────────┐                              │
        │  COMPLETED  │                              │
        └──────┬──────┘                              │
               │                                     │
               │ 删除                                 │
               ▼                                     │
        ┌─────────────┐                              │
        │   DELETED   │                              │
        └─────────────┘                              │
               │                                     │
               └─────────────────────────────────────┘
```

### 4.3 部署状态图

```
        ┌─────────────┐
        │  DEPLOYING  │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │  DEPLOYED   │◄─────────────────────────────┐
        └──────┬──────┘                              │
               │                                     │
               │ 暂停                                 │
               ▼                                     │
        ┌─────────────┐                              │
        │  SUSPENDED  │                              │
        └──────┬──────┘                              │
               │                                     │
               │ 激活                                 │
               │                                     │
               └─────────────────────────────────────┘
               │
               │ 删除
               ▼
        ┌─────────────┐
        │  DELETED    │
        └─────────────┘
```

## 5. 组件交互关系图

### 5.1 引擎与服务交互图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           ProcessEngine                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ RepositoryService │  │ RuntimeService    │  │ TaskService       │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        CommandExecutor                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ CommandContext   │  │ Command          │  │ CommandInterceptor│              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        EntityManager                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ DeploymentEntity │  │ ProcessDefinition │  │ ProcessInstance   │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ACT_RU_DEPLOYMENT│  │ACT_REU_PROCDEF  │  │ACT_RU_EXECUTION  │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 事件分发机制图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        EventSource                                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ProcessInstance │  │ Task             │  │ Execution        │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      EventDispatcher                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ EventListener    │  │ EventListener    │  │ EventListener    │              │
│  │ Registry        │  │ Registry        │  │ Registry        │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      EventListeners                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ TaskListener     │  │ ProcessListener │  │ ExecutionListener │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 异步执行机制图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        JobCreator                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ AsyncJob        │  │ TimerJob        │  │ MessageJob       │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        JobQueue                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ AsyncJobQueue   │  │ TimerJobQueue   │  │ MessageJobQueue  │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      AsyncExecutor                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ JobAcquisition  │  │ JobExecution    │  │ JobRetry         │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      JobExecution                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ CommandExecutor  │  │ CommandContext   │  │ Command          │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        JobHistory                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ HistoricJob     │  │ HistoricLog     │  │ HistoricException│              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 6. 数据流向图

### 6.1 流程部署数据流

```
BPMN文件
    │
    │ 解析
    ▼
BpmnModel
    │
    │ 验证
    ▼
ValidatedBpmnModel
    │
    │ 转换
    ▼
ProcessDefinitionEntity
    │
    │ 存储
    ▼
Database (ACT_RE_PROCDEF)
    │
    │ 缓存
    ▼
ProcessDefinitionCache
```

### 6.2 流程启动数据流

```
用户请求
    │
    │ 创建流程实例
    ▼
ProcessInstanceBuilder
    │
    │ 设置变量
    ▼
ProcessVariables
    │
    │ 创建执行
    ▼
ExecutionManager
    │
    │ 创建任务
    ▼
TaskManager
    │
    │ 存储数据
    ▼
Database (ACT_RU_EXECUTION, ACT_RU_TASK)
    │
    │ 触发事件
    ▼
EventDispatcher
```

### 6.3 任务完成数据流

```
用户请求
    │
    │ 获取任务
    ▼
TaskEntity
    │
    │ 触发完成事件
    ▼
TaskListener
    │
    │ 更新任务状态
    ▼
Database (ACT_RU_TASK)
    │
    │ 信号执行
    ▼
ExecutionManager
    │
    │ 更新执行状态
    ▼
Database (ACT_RU_EXECUTION)
    │
    │ 创建新任务
    ▼
TaskManager
    │
    │ 触发事件
    ▼
EventDispatcher
```

## 7. 缓存机制图

### 7.1 流程定义缓存

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        CacheManager                                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ProcessDefCache │  │ DeploymentCache  │  │ ModelCache       │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            │ get()               │ get()                │ get()
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        CacheHit/Miss                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Cache Hit       │  │ Cache Miss      │  │ Load from DB     │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ACT_RE_PROCDEF  │  │ACT_RU_DEPLOYMENT│  │ACT_GE_BYTEARRAY  │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
            │
            │ load
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        CacheUpdate                                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Put to Cache   │  │ Update Cache    │  │ Invalidate Cache  │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 部署缓存

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      DeploymentCacheManager                                │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ DeploymentCache │  │ ResourceCache    │  │ ProcessDefCache  │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            │ getDeployment()     │ getResource()        │ getProcessDef()
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      CacheLookup                                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Found in Cache  │  │ Not in Cache    │  │ Load from DB      │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ACT_RU_DEPLOYMENT│  │ACT_GE_BYTEARRAY  │  │ACT_RE_PROCDEF    │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
            │
            │ update cache
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      CacheUpdate                                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Put Deployment  │  │ Put Resource     │  │ Put ProcessDef   │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 8. 事务管理机制图

### 8.1 事务边界图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      TransactionManager                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Begin Transaction│  │ Commit           │  │ Rollback         │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      CommandContext                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Session         │  │ EntityManager    │  │ Cache            │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Database Operations                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ INSERT          │  │ UPDATE           │  │ DELETE           │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ACT_RU_*        │  │ACT_HI_*          │  │ACT_GE_*          │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 嵌套事务图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Outer Transaction                                 │
│  ┌──────────────────────────────────────────────────────────────────┐            │
│  │  Begin Transaction                                         │            │
│  └──────────────────────────────┬─────────────────────────────────┘            │
│                             │                                              │
│                             ▼                                              │
│  ┌──────────────────────────────────────────────────────────────────┐            │
│  │  Command 1 Execution                                      │            │
│  │  ┌────────────────────────────────────────────────────────┐   │            │
│  │  │  Inner Transaction 1                            │   │            │
│  │  │  ┌────────────────────────────────────────────┐   │   │            │
│  │  │  │  Database Operations                      │   │   │            │
│  │  │  └────────────────────────────────────────────┘   │   │            │
│  │  │  Commit/Rollback                            │   │   │            │
│  │  └────────────────────────────────────────────────────┘   │            │
│  └─────────────────────────────────────────────────────────────────┘            │
│                             │                                              │
│                             ▼                                              │
│  ┌──────────────────────────────────────────────────────────────────┐            │
│  │  Command 2 Execution                                      │            │
│  │  ┌────────────────────────────────────────────────────────┐   │            │
│  │  │  Inner Transaction 2                            │   │            │
│  │  │  ┌────────────────────────────────────────────┐   │   │            │
│  │  │  │  Database Operations                      │   │   │            │
│  │  │  └────────────────────────────────────────────┘   │   │            │
│  │  │  Commit/Rollback                            │   │   │            │
│  │  └────────────────────────────────────────────────────┘   │            │
│  └─────────────────────────────────────────────────────────────────┘            │
│                             │                                              │
│                             ▼                                              │
│  ┌──────────────────────────────────────────────────────────────────┐            │
│  │  Commit Outer Transaction                              │            │
│  └──────────────────────────────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 9. 安全机制图

### 9.1 身份认证流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          User                                            │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Username        │  │ Password         │  │ Token            │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      AuthenticationFilter                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Extract Creds   │  │ Validate Creds   │  │ Generate Token    │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      IdentityService                                    │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ UserQuery       │  │ Check Password   │  │ Create Token      │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ACT_ID_USER     │  │ ACT_ID_INFO      │  │ ACT_ID_TOKEN     │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
            │
            │ return token
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          User                                            │
│  ┌──────────────────┐                                                      │
│  │ Auth Token      │                                                      │
│  └──────────────────┘                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 权限控制流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          User                                            │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Auth Token       │  │ Request          │  │ Action           │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      AuthorizationFilter                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Extract Token    │  │ Validate Token   │  │ Check Permission │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      IdentityService                                    │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ UserQuery       │  │ GroupQuery       │  │ PrivilegeQuery   │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ACT_ID_USER     │  │ ACT_ID_GROUP     │  │ ACT_ID_PRIV      │              │
│  │ ACT_ID_MEMBERSHIP│  │ ACT_ID_MEMBERSHIP│  │ ACT_ID_PRIV      │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
            │
            │ allow/deny
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Service                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Execute Action  │  │ Return Result    │  │ Return Error     │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 10. 多租户架构图

### 10.1 多租户数据隔离图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      TenantManager                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Tenant 1        │  │ Tenant 2         │  │ Tenant 3         │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      ProcessEngine                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ProcessInstance  │  │ Task             │  │ Execution        │              │
│  │ (tenantId=1)    │  │ (tenantId=1)      │  │ (tenantId=1)      │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ACT_RU_EXECUTION│  │ACT_RU_TASK       │  │ACT_HI_PROCINST   │              │
│  │ (TENANT_ID_=1)  │  │(TENANT_ID_=1)    │  │(TENANT_ID_=1)    │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 多租户查询流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      User (Tenant 1)                                  │
│  ┌──────────────────┐                                                      │
│  │ Query Request    │                                                      │
│  └────────┬─────────┘                                                      │
└───────────┼──────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Service                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Query Builder   │  │ Set Tenant ID   │  │ Execute Query    │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      CommandExecutor                                   │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ CommandContext  │  │ Tenant Filter   │  │ Query Execution  │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ SELECT * FROM   │  │ WHERE TENANT_ID  │  │ = 'tenant-1'     │              │
│  │ ACT_RU_TASK     │  │                  │  │                  │              │
│  └────────┬─────────┘  └──────────────────┘  └──────────────────┘              │
└───────────┼──────────────────────────────────────────────────────────────────────┘
            │
            │ return results
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Service                                         │
│  ┌──────────────────┐                                                      │
│  │ Filter Results  │                                                      │
│  └────────┬─────────┘                                                      │
└───────────┼──────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      User (Tenant 1)                                  │
│  ┌──────────────────┐                                                      │
│  │ Query Results    │                                                      │
│  └──────────────────┘                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 11. 性能监控架构图

### 11.1 性能监控数据流

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Application                                      │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Process Engine   │  │ Task Service     │  │ Job Service      │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      MetricsCollector                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Execution Time  │  │ Task Count       │  │ Job Count        │              │
│  │ Cache Hit Rate  │  │ Task Duration   │  │ Job Duration     │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      MetricsRepository                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Store Metrics   │  │ Query Metrics   │  │ Aggregate Metrics│              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Database                                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ ACT_RU_METRICS  │  │ACT_HI_METRICS   │  │ACT_HI_METRICS   │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Monitoring Dashboard                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Performance Chart│  │ Throughput Chart│  │ Error Rate Chart │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.2 健康检查架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      HealthChecker                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Engine Health   │  │ Database Health  │  │ Cache Health     │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Health Indicators                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Engine Status    │  │ DB Connection    │  │ Cache Status     │              │
│  │ UP/DOWN         │  │ UP/DOWN         │  │ UP/DOWN         │              │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘              │
└───────────┼──────────────────────┼──────────────────────┼──────────────────────┘
            │                      │                      │
            ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      Health Status                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │
│  │ Overall Status   │  │ Details         │  │ Recommendations  │              │
│  │ UP/DOWN         │  │ Component Status │  │ Actions          │              │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 12. 总结

本文档提供了Flowable Engine的全面架构可视化图表，涵盖了系统层次架构、模块依赖关系、核心业务流程、状态管理机制、组件交互关系、数据流向、缓存机制、事务管理、安全机制、多租户架构和性能监控等方面。

这些可视化图表为理解Flowable Engine的架构设计和工作原理提供了直观的参考，有助于开发者和架构师更好地理解和应用Flowable Engine。

### 12.1 图表分类

| 图表类型 | 数量 | 用途 |
|---------|------|------|
| 整体架构图 | 2 | 系统层次和模块依赖 |
| 核心业务流程图 | 3 | 部署、启动、完成任务 |
| 状态管理图 | 3 | 流程实例、任务、部署状态 |
| 组件交互图 | 3 | 引擎服务、事件分发、异步执行 |
| 数据流向图 | 3 | 部署、启动、完成任务 |
| 缓存机制图 | 2 | 流程定义、部署缓存 |
| 事务管理图 | 2 | 事务边界、嵌套事务 |
| 安全机制图 | 2 | 身份认证、权限控制 |
| 多租户架构图 | 2 | 数据隔离、查询流程 |
| 性能监控图 | 2 | 性能监控、健康检查 |

### 12.2 使用建议

1. **架构理解**：从整体架构图开始，理解系统层次和模块依赖
2. **流程分析**：通过业务流程图理解核心工作流程
3. **状态管理**：通过状态图理解对象生命周期
4. **交互分析**：通过组件交互图理解模块间通信
5. **数据流分析**：通过数据流向图理解数据传递
6. **性能优化**：通过缓存和监控图理解性能机制

通过这些可视化图表，可以全面理解Flowable Engine的架构设计和工作原理，为项目开发、维护和优化提供有力支持。
